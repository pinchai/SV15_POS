<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POS Screen</title>
  <link rel="stylesheet" href="boostrap.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-7">
      <div class="row" id="main_product_card"></div>
    </div>
    <div class="col-5 mt-3">
      <div class="card product-card" style="width: 100%;">
        <div class="card-header">
          <h3>Select Product</h3>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-borderless table-striped">
              <thead class="bg-primary text-white">
              <tr>
                <th>No.</th>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
              </thead>
              <tbody id="select_product_tr_box">

              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <table class="table table-bordered">
            <!--total-->
            <tr>
              <th>
                <h3>Total: </h3>
              </th>
              <th
                style="text-align: right;"
              >
                <h3 id="total_usd">0 $</h3>
                <h3 id="total_khr">0 ៛</h3>
              </th>
            </tr>
            <!--received-->
            <tr>
              <th>
                <h3>Received: </h3>
              </th>
              <th
                style="text-align: right;"
              >
                <input
                  style="width: 100%;height: 55px;font-size: 50px;text-align: right;color: red;"
                  type="number"
                  id="received"
                  onkeyup="getChangeAmount()"
                >
              </th>
            </tr>
            <!--change amount-->
            <tr>
              <th>
                <h3>Change: </h3>
              </th>
              <th
                style="text-align: right;"
              >
                <h3
                  style="display: none;width: 100%; background-color:yellow; height: 55px;font-size: 50px;text-align: right;color: red;"
                  id="change_amount"
                ></h3>
              </th>
            </tr>
            <!--Btn-->
            <tr>
              <th>
                <input
                  onclick="cancel()"
                  type="button"
                  value="Cancel"
                  id="btn_cancel"
                  class="btn btn-danger"
                  style="height: 70px; font-size: 30px;text-align: center;"
                >
              </th>
              <th>
                <input
                  type="button"
                  value="Pay Now"
                  id="btn_pay"
                  style="height: 70px; font-size: 30px;text-align: center;"
                  class="btn btn-primary w-100"
                >
              </th>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
<script>
    let product_list = JSON.parse(localStorage.getItem('product_list') ?? '[]');
    let selected_product = []
    let main_product_card = document.getElementById('main_product_card')
    let select_product_tr_box = document.getElementById('select_product_tr_box')
    let btn_pay = document.getElementById('btn_pay')
    let input_received = document.getElementById('received')
    let total = 0
    let change_amount = 0

    renderProductCard()

    function renderProductCard() {
        let html_card = ''
        product_list.forEach((product, index) => {
            html_card += `
            <div class="col-3 mt-3" onclick="cardOnClick(${index})">
              <div
              class="card product-card"
               style="width: 100%;"
               >
              <center>
                <img
                  src="${product.image_url}"
                  class="card-img-top product-image"
                  alt="coca"
                >
              </center>
              <div class="card-body">
                <h5 class="card-title">${product.name}</h5>
                <p class="card-text">${product.price} $</p>
              </div>
          </div>
            </div>
          `
        })
        main_product_card.innerHTML = html_card
    }

    function renderSelectProduct() {
        let select_product_tr = ''
        selected_product.forEach((product, index) => {
            let total = product.price * product.quantity
            select_product_tr += `
             <tr>
                <td>${index + 1}</td>
                <td>${product.name}</td>
                <td>${product.price} $</td>
                <td>${product.quantity}</td>
                <td>${total}</td>
                <td>
                  <a onclick="deleteItem(${index})" href="#" class="btn btn-sm btn-outline-secondary">❌</a>
                </td>
              </tr>
          `
        })
        select_product_tr_box.innerHTML = select_product_tr
    }

    function cardOnClick(index) {
        let current_product = product_list[index]
        let dpl_index = null
        for (let i = 0; i < selected_product.length; i++) {
            if (current_product.name === selected_product[i].name) {
                dpl_index = i
                break
            }

        }
        if (dpl_index !== null) {
            selected_product[dpl_index].quantity += 1
        } else {
            current_product.quantity = 1
            selected_product.push(current_product)
        }
        //render
        renderSelectProduct()
        //total
        getTotal()
    }

    function deleteItem(index) {
        let del_confirm = confirm('Are you sure you want to delete this product?')
        if (del_confirm) {
            selected_product.splice(index, 1)
            renderSelectProduct()
        }
    }

    function getTotal() {
        selected_product.forEach((product, index) => {
            total += product.price * product.quantity
        })
        document.getElementById('total_usd').innerText = `${total.toFixed(2)} $`
        document.getElementById('total_khr').innerText = ((parseFloat(total) * 4100).toLocaleString()).toString() + ' ៛'
    }

    btn_pay.addEventListener('click', (e) => {
        let received = input_received.value
        console.log(parseFloat(received), total)
        if (parseFloat(received) < total || parseFloat(received) == null) {
            alert("received must be greater than total")
            return
        }

        localStorage.setItem('selected_product', JSON.stringify(selected_product))
        let width = 600
        let height = 600
        let left = (window.screen.width - width) / 2;
        let top = (window.screen.height - height) / 2;
        window.open(
            'invoice.html',
            '_blank',
            `width=600,height=600,
             left=${left},
             top=${top}`
        )
    })

    function getChangeAmount() {
        let label_change_amount = document.getElementById('change_amount')
        let received = input_received.value
        change_amount = parseFloat(received) - parseFloat(total)
        label_change_amount.innerText = change_amount
        if (change_amount > 0) {
            label_change_amount.style.display = 'block'
        } else {
            label_change_amount.style.display = 'none'
        }

    }

    function cancel() {
        if (confirm('Are you sure you want to cancel the product?')) {
            total = 0
            selected_product = []
            renderSelectProduct()
            getTotal()
            document.getElementById('received').value = 0
            document.getElementById('change_amount').innerText = ''
            document.getElementById('change_amount').style.display = 'none'
        }
    }
</script>
</html>